<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="js/forms.js"></script>
  <script src="js/selector.js"></script>
  <script src="js/tabs.js"></script>
  <script src="js/disable_step_validation.js"></script>
  <script src="js/align_checkboxes.js"></script>
  <script src="js/persistence.js"></script>
  <script>
    function onload() {
      generate_tabs()
      switchTabs(0)
      disable_step_validation()
      align_checkboxes()
      auto_load()
    }
  </script>
  <link rel="stylesheet" href="css/styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEUWON Model Editor</title>
  <meta name="application-name" content="NEUWON Model Editor">
  <meta name="description"      content="NEUWON Model Editor">
  <meta name="keywords" content="NEUWON, Neuroscience, Science, Simulator, Simulation, Conductance">
  <meta name="author" content="David McDougall">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
  <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
</head>

<body onload="onload()" onbeforeunload="auto_save()">

<div class="menu-bar">
  <button class="menu-btn" onclick="save()">Save</button>
  <button class="menu-btn" onclick="load_button.click()">Load</button>
  <input  id="load_button" type="file" accept=".json"
      onchange="load(load_button.files[0])"
      style="display: none;">
  <button class="menu-btn" onclick="alert('unimplemented!')">Help</button>
  <button class="menu-btn" onclick="reset()">New</button>
  <button class="menu-btn" onclick="run()">Run</button>
  <button class="menu-btn" onclick="open_about_page()">About</button>
  <script>
    function open_about_page() {
      const popup = window.open("about.html", "About_NEUWON", "height=300,width=400")
    }

    function run() {
      let xhr = new XMLHttpRequest()
      let url = "submit.php"
      xhr.open("POST", url, true)
      xhr.setRequestHeader("Content-Type", "application/json")
      // Create a state change callback
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          // Print received data from server
          result.innerHTML = this.responseText
        }
      }
      xhr.send(get_parameters())
    }
  </script>

  <h1>NEUWON Model Editor</h1>
</div>

<nav id="tabs_bar"> <!-- Content generated by onload() --> </nav>

<section id="simulation_tab" data-tab-name="Settings">
  <form name="simulation_settings" class="settings-grid">

    <label>Time Step (ms)
      <input type="number" required
          name="time_step"
          step="0.01"
          min="0"
          max="10"
          value="0.1" />
    </label>

    <label>Temperature (°C)
      <input type="number" required
          name="temperature"
          min="0"
          max="100"
          value="37" />
    </label>

    <label>Initial Voltage (mV)
      <input type="number" required
          name="initial_voltage"
          min="-1000"
          max="1000"
          value="-70" />
    </label>

    <label>Cytoplasmic Resistance (Ω-cm)
      <input type="number" required
          name="cytoplasmic_resistance"
          min="0"
          value="100" />
    </label>

    <label>Membrane Capacitance (μf/cm²)
      <input type="number" required
          name="membrane_capacitance"
          step="0.01"
          min="0"
          value="1" />
    </label>
  </form>
</section>

<section id="mechanisms_tab" data-tab-name="Mechanisms">
  <div style="display: inline-grid; grid-template-columns: auto auto;">

    <div id="mechanism_selector">
      <button type="button" onclick="select_mechanism_file.click()">Upload</button>
      <button type="button" onclick="mechanism_list.remove_item()">Remove</button>
      <input  id="select_mechanism_file" type="file"
          accept=".mod,.py" multiple
          onchange="onselect_mechanism_file()"
          style="display: none;">
    </div>

    <div id="selected_mechanism_bg" class="code-bg">
      <pre id="selected_mechanism_text" class="code"></pre>
    </div>
  </div>

  <script>
    function onselect_mechanism_file() {
      for (const f of select_mechanism_file.files) {
        const reader = new FileReader()
        if (f.name.endsWith(".mod")) {
          reader.onload = (event => import_nmodl_file(f.name, event.target.result))
        }
        else if (f.name.endsWith(".py")) {
          alert("unimplemented!")
        }
        reader.readAsText(f)
      }
    }

    function import_nmodl_file(file_name, text) {
      text = text.trim()
      const match = text.match(/(SUFFIX|POINT_PROCESS)\s+(\w+)/)
      if (!match) {
        alert(`Error parsing NMODL file "${file_name}"!`)
        return
      }
      const [_, mech_type, name] = match
      if (!mechanism_list.items.every(m => m.name != name)) {
        alert(`Mechanism "${name}" is already defined!`)
        return
      }
      const obj = {
          file_type: "nmodl",
          mech_type: mech_type,
          text: text}
      mechanism_list.add_item(name, obj)
    }

    class MechanismSelector extends Selector {
      select(obj) {
        selected_mechanism_text.innerText = obj.text
        selected_mechanism_bg.style.display = ""
      }
      deselect(obj) {
        selected_mechanism_bg.style.display = "none"
      }
    }
    const mechanism_list = new MechanismSelector(mechanism_selector)

    // Initially hide the file display panel, since no file is selected.
    selected_mechanism_bg.style.display = "none"
  </script>
</section>

<section id="species_tab" data-tab-name="Chemicals">
  <div id="species_selector">
    <button onclick="create_species()">Create</button>
    <button onclick="species_list.remove_item()">Delete</button>
    <input id="new_species_name" type="text" class="input-name"
        placeholder="Enter New Chemical Name" />
  </div>

  <form name="species_settings" class="settings-grid">

    <label>Charge
      <input type="number" required
          name="charge"
          step="1"
          data-strict-step
          value="0" />
    </label>

    <label>Diffusivity
      <input type="number" required
          name="diffusivity"
          step="any"
          min="0"
          value="0" />
    </label>

    <label>Decay
      <input
          type="checkbox"
          name="decay" />
    </label>

    <label>Decay Period (ms)
      <input type="number"
          name="decay_period"
          min="0"
          value="" />
    </label>

    <fieldset class="spancol settings-grid">
      <legend>Intracellular</legend>

      <label>Global Constant
        <input type="checkbox" name="inside_global_constant" checked />
      </label>

      <label>Initial Concentration (mmol)
        <input type="number" required
            name="inside_initial_concentration"
            min="0"
            value="0" />
      </label>
    </fieldset>

    <fieldset class="spancol settings-grid">
      <legend>Extracellular</legend>

      <label>Global Constant
        <input type="checkbox" name="outside_global_constant" checked />
      </label>

      <label>Initial Concentration (mmol)
        <input type="number" required
            name="outside_initial_concentration"
            min="0"
            value="0" />
      </label>
    </fieldset>
  </form>

  <script>
    disable_form(species_settings)

    class SpeciesSelector extends Selector {
      select(obj) {
        set_form_values(species_settings, obj)
        enable_form(species_settings)
      }
      deselect(obj) {
        get_form_values(species_settings, obj)
        species_settings.reset()
        disable_form(species_settings)
      }
    }

    const species_list = new SpeciesSelector(species_selector)

    function create_species() {
      const default_values = get_default_form_values(species_settings)
      species_list.add_item(new_species_name, default_values)
    }
  </script>
</section>

<section id="regions_tab" data-tab-name="Regions">
  <div style="display: inline-grid; grid-template-columns: auto auto;">
    <div id="region_selector">
      <button onclick="create_region('rect')">        Rectangle</button>
      <button onclick="create_region('union')">       Union</button>
      <button onclick="create_region('sphere')">      Sphere</button>
      <button onclick="create_region('intersect')">   Intersection</button>
      <button onclick="create_region('cylinder')">    Cylinder</button>
      <button onclick="create_region('not')">         Negative</button>
      <button onclick="region_list.remove_item()" class="spancol">Delete Region</button>
      <input id="new_region_name" type="text" class="input-name"
          placeholder="Enter New Region Name" />
    </div>

    <form name="rectangle_settings">
      <fieldset class="settings-grid">
        <legend>Axis Aligned Rectangle</legend>

        <label>X Boundary 1 (μm)
          <input type="number" required
              name="x1"
              step="10"
              value="0" />
        </label>

        <label>X Boundary 2 (μm)
          <input type="number" required
              name="x2"
              step="10"
              value="100" />
        </label>

        <label>Y Boundary 1 (μm)
          <input type="number" required
              name="y1"
              step="10"
              value="0" />
        </label>

        <label>Y Boundary 2 (μm)
          <input type="number" required
              name="y2"
              step="10"
              value="100" />
        </label>

        <label>Z Boundary 1 (μm)
          <input type="number" required
              name="z1"
              step="10"
              value="0" />
        </label>

        <label>Z Boundary 2 (μm)
          <input type="number" required
              name="z2"
              step="10"
              value="100" />
        </label>
      </fieldset>
    </form>

    <form name="sphere_settings">
      <fieldset class="settings-grid">
        <legend>Sphere</legend>

        <label>Center X (μm)
          <input type="number" required
              name="x"
              step="10"
              value="0" />
        </label>

        <label>Center Y (μm)
          <input type="number" required
              name="y"
              step="10"
              value="0" />
        </label>

        <label>Center Z (μm)
          <input type="number" required
              name="z"
              step="10"
              value="0" />
        </label>

        <label>Radius (μm)
          <input type="number" required
              name="r"
              step="10"
              value="100" />
        </label>
      </fieldset>
    </form>

    <form name="cylinder_settings">
      <fieldset class="settings-grid">
        <legend>Right Cylinder</legend>

        <label>Base X (μm)
          <input type="number" required
              name="x1"
              step="10"
              value="0" />
        </label>

        <label>Base Y (μm)
          <input type="number" required
              name="y1"
              step="10"
              value="0" />
        </label>

        <label>Base Z (μm)
          <input type="number" required
              name="z1"
              step="10"
              value="0" />
        </label>

        <label>Cap X (μm)
          <input type="number" required
              name="x2"
              step="10"
              value="100" />
        </label>

        <label>Cap Y (μm)
          <input type="number" required
              name="y2"
              step="10"
              value="100" />
        </label>

        <label>Cap Z (μm)
          <input type="number" required
              name="z2"
              step="10"
              value="100" />
        </label>

        <label>Radius (μm)
          <input type="number" required
              name="r"
              step="10"
              value="100" />
        </label>
      </fieldset>
    </form>

    <form name="union_settings">
      <fieldset class="settings-grid">
        <legend>Union</legend>

        <label>Region 1
          <select name="rgn1" required></select>
        </label>

        <label>Region 2
          <select name="rgn2" required></select>
        </label>
      </fieldset>
    </form>

    <form name="intersect_settings">
      <fieldset class="settings-grid">
        <legend>Intersection</legend>

        <label>Region 1
          <select name="rgn1" required></select>
        </label>

        <label>Region 2
          <select name="rgn2" required></select>
        </label>
      </fieldset>
    </form>

    <form name="not_settings">
      <fieldset class="settings-grid">
        <legend>Negative</legend>

        <label>Region
          <select name="rgn" required></select>
        </label>
      </fieldset>
    </form>
  </div>

  <script>
    const region_forms = {
        rect:       rectangle_settings,
        union:      union_settings,
        sphere:     sphere_settings,
        intersect:  intersect_settings,
        cylinder:   cylinder_settings,
        not:        not_settings,
    }
    // Initially hide all of the forms, since there is nothing selected.
    for (const form of Object.values(region_forms)) {
      form.style.display = "none"
    }

    class RegionSelector extends Selector {
      select(obj) {
        const form = region_forms[obj.rgn_type]
        // Update the drop-down menus, which contain references to other regions.
        for (const item of form) {
          if (item.tagName == "SELECT") {
            // First remove the existing options.
            while (item.lastChild) {
              item.removeChild(item.lastChild)
            }
            // Add option for each region.
            for (const rgn of this.items) {
              if (rgn.name != obj.name) { // Regions can not reference themselves.
                item.appendChild(new Option(rgn.name))
              }
            }
          }
        }
        set_form_values(form, obj)
        form.style.display = ""
      }
      deselect(obj) {
        const form = region_forms[obj.rgn_type]
        get_form_values(form, obj)
        form.style.display = "none"
      }
    }
    const region_list = new RegionSelector(region_selector)

    function create_region(rgn_type) {
      const form = region_forms[rgn_type]
      const obj = get_default_form_values(form)
      obj.rgn_type = rgn_type
      region_list.add_item(new_region_name, obj)
    }
  </script>
</section>

<section id="neurons_tab" data-tab-name="Neurons">
  <div style="display: inline-grid; grid-template-columns: repeat(3, auto);">

    <div id="neuron_selector">
      <label><b>Neuron Types</b></label>
      <button onclick="create_neuron()">Create</button>
      <button onclick="neuron_list.remove_item()">Delete</button>
      <button onclick="duplicate_neuron()">Duplicate</button>
      <div> <!-- Placeholder --> </div>
      <input id="new_neuron_name" type="text" class="input-name"
          placeholder="Enter New Neuron Name" />
    </div>

    <div id="segment_selector">
      <label><b>Segment Types</b></label>
      <button onclick="create_segment('dend')">Dendrite</button>
      <div> <!-- Placeholder --> </div>
      <button onclick="create_segment('axon')">Axon</button>
      <button onclick="segment_up()">Move Up</button>
      <button onclick="delete_segment()">Delete</button>
      <button onclick="segment_down()">Move Down</button>
      <input id="new_segment_name" type="text" class="input-name"
          placeholder="Enter New Segment Name" />
    </div>

    <div style="display: inline-grid; grid-template-columns: auto; grid-row-gap: var(--pad);">
    <form name="soma_settings">
      <fieldset class="settings-grid">
        <legend>Soma</legend>

        <label>Region
          <select name="region" required onmousedown="populate_regions_menu(event)"></select>
        </label>

        <label>Cell Density (cells/μm³)
          <input type="number"
              name="density"
              step="any"
              min="0"
              value=".00001" />
        </label>

        <label>Diameter (μm)
          <input type="number" required
              name="diameter"
              min="0"
              value="10" />
        </label>
      </fieldset>
    </form>

    <form name="dend_settings">
      <fieldset class="settings-grid">
        <legend>Dendrite</legend>

        <label>Region
          <select name="region" required onmousedown="populate_regions_menu(event)"></select>
        </label>

        <label>Density (carrier-points/μm³)
          <input type="number" required
              name="carrier_point_density"
              step="any"
              value="3" />
        </label>

        <label>Competitive Growth
          <input type="checkbox"
              name="competitive_growth"
              checked />
        </label>

        <label>Balancing Factor
          <input type="range"
              name="balancing_factor"
              step=".1"
              min="0"
              max="1"
              value=".5" />
        </label>

        <label>Diameter (μm)
          <input type="number" required
              name="diameter"
              step="0.1"
              value="3" />
        </label>

        <label>Maximum Segment Length (μm)
          <input type="number" required
              name="maximum_segment_length"
              min="0"
              value="20" />
        </label>
      </fieldset>
    </form>

    <form name="axon_settings">
      <fieldset class="settings-grid">
        <legend>Axon</legend>

        <label>Region
          <select name="region" required onmousedown="populate_regions_menu(event)"></select>
        </label>

        <label>Density (carrier-points/μm³)
          <input type="number" required
              name="carrier_point_density"
              step="any"
              min="0"
              value="3" />
        </label>

        <label>Diameter (μm)
          <input type="number" required
              name="diameter"
              step="0.1"
              min="0"
              value="3" />
        </label>

        <label>Maximum Segment Length (μm)
          <input type="number" required
              name="maximum_segment_length"
              min="0"
              value="20" />
        </label>

        <label>Maximum Extension Angle (°)
          <input type="range"
              name="maximum_extension_angle"
              step="5"
              min="0"
              max="180"
              value="60" />
        </label>

        <label>Maximum Extension Distance (μm)
          <input type="number" required
              name="maximum_extension_distance"
              step="10"
              min="0"
              value="100" />
        </label>

        <label>Maximum Branch Angle (°)
          <input type="range"
              name="maximum_branch_angle"
              step="5"
              min="0"
              max="180"
              value="60" />
        </label>

        <label>Maximum Branch Distance (μm)
          <input type="number" required
              name="maximum_branch_distance"
              step="10"
              min="0"
              value="100" />
        </label>
      </fieldset>
    </form>

    <div id="insert_selector">
      <label><b>Mechanisms</b></label>
      <label for="insert_btn" style="display: none">Insert</label>
      <select id="insert_btn"
          onmousedown="insert_list.populate_insert_menu(event)"
          onchange="insert_list.insert_mechanism()" >
        <option value="" selected>Insert</option>
      </select>
      <button type="button" onclick="insert_list.remove_item()">Remove</button>
      <form name="insert_settings" id="insert_settings" style="display: none">
      </form>
      <label for="mechanism_magnitude">Magnitude</label>
      <input id="mechanism_magnitude"
          type="number" required
          form="insert_settings"
          name="magnitude"
          min="0"
          step="0.01"
          value="1" />
    </div>
    </div>
  </div>

  <script>
    class NeuronSelector extends Selector {
      select(obj) {
        segment_list.set_items(obj.program)
        segment_list.show()
      }
      deselect(obj) {
        obj.program = segment_list.get_items()
        segment_list.hide()
      }
    }
    const neuron_list = new NeuronSelector(neuron_selector)

    function create_neuron() {
      const soma = get_default_form_values(soma_settings)
      soma.seg_type = "soma"
      soma.name = "Soma"
      soma.mechanisms = []
      const obj = {program: [soma]}
      neuron_list.add_item(new_neuron_name, obj)
    }
    function duplicate_neuron() {
      const orig = neuron_list.get_selected()
      if (!orig) return
      const dup = JSON.parse(JSON.stringify(orig))
      neuron_list.add_item(new_neuron_name, dup)
    }

    const segment_forms = {
      soma: soma_settings,
      dend: dend_settings,
      axon: axon_settings,
    }

    class SegmentSelector extends Selector {
      select(obj) {
        const form = segment_forms[obj.seg_type]
        set_form_values(form, obj)
        form.style.display = ""
        insert_list.set_items(obj.mechanisms)
        insert_list.show()
      }
      deselect(obj) {
        const form = segment_forms[obj.seg_type]
        get_form_values(form, obj)
        form.style.display = 'none'
        obj.mechanisms = insert_list.get_items()
        insert_list.hide()
      }
    }
    const segment_list = new SegmentSelector(segment_selector, keep_sorted=false)

    function create_segment(seg_type) {
      const form = segment_forms[seg_type]
      const obj = get_default_form_values(form)
      obj.seg_type = seg_type
      obj.mechanisms = []
      segment_list.add_item(new_segment_name, obj)
    }
    function delete_segment() {
      const obj = segment_list.remove_item()
      if (obj.seg_type == "soma") {
        neuron_list.remove_item(require_confirmation=false)
      }
    }
    function segment_up() {
      if (segment_list.index == 1)
        return
      segment_list.move_up()
    }
    function segment_down() {
      if (segment_list.index == 0)
        return
      segment_list.move_down()
    }
    function populate_regions_menu(event) {
      if (event.buttons != 1) return
      const select_tag = event.target
      while (select_tag.lastChild) {
        select_tag.removeChild(select_tag.lastChild)
      }
      select_tag.appendChild(new Option(""))
      for (const rgn of region_list.items) {
        select_tag.appendChild(new Option(rgn.name))
      }
    }

    class InsertMechanisms extends Selector {
      constructor(selector_box, dropdown_menu, settings) {
        super(selector_box)
        this.dropdown_menu = dropdown_menu
        this.settings = settings
        disable_form(this.settings)
      }

      select(obj) {
        set_form_values(this.settings, obj)
        enable_form(this.settings)
      }

      deselect(obj) {
        get_form_values(this.settings, obj)
        this.settings.reset()
        disable_form(this.settings)
      }

      populate_insert_menu(event) {
        if (event.buttons != 1) return
        // Remove existing options from the drop down menu, except for the default option.
        const dropdown = this.dropdown_menu
        while (dropdown.children.length > 1) {
          dropdown.removeChild(dropdown.lastChild)
        }
        // Add all mechanisms to the menu.
        for (const m of mechanism_list.items) {
          dropdown.appendChild(new Option(m.name))
        }
        if (mechanism_list.items.length == 0) {
          dropdown.appendChild(new Option("-nothing available-", ""))
        }
      }

      insert_mechanism() {
        const mech = this.dropdown_menu.value
        const obj = get_default_form_values(this.settings)
        this.add_item(mech, obj)
        this.dropdown_menu.selectedIndex = 0
      }
    }

    const insert_list = new InsertMechanisms(insert_selector, insert_btn, insert_settings)

    // Initially hide everything, since nothing is selected.
    for (const form of Object.values(segment_forms)) { form.style.display = "none" }
    segment_list.hide()
    insert_list.hide()
  </script>
</section>

<section id="synapses_tab" data-tab-name="Synapses">
  <div style="display: inline-grid; grid-template-columns: repeat(3, auto); grid-gap: var(--pad2);">

    <div id="synapse_selector">
      <label><b>Synapse Types</b></label>
      <button onclick="create_synapse()">Create</button>
      <button onclick="synapse_list.remove_item()">Delete</button>
      <input id="new_synapse_name" type="text" class="input-name"
          placeholder="Enter New Synapse Name" />
    </div>

    <form name="synapse_settings">
      <fieldset class="settings-grid">
        <label>Maximum Distance (μm)
          <input type="number" required
              name="maximum_distance"
              step="1"
              min="0"
              value="5" />
        </label>

        <label>Cleft Volume (μm³)
          <input type="number" required
              name="cleft_volume"
              step="1"
              min="0"
              value="1" />
        </label>

        <label>Cleft Spillover Area (μm²)
          <input type="number" required
              name="cleft_spillover_area"
              step="1"
              min="0"
              value="3" />
        </label>
      </fieldset>
    </form>

    <div id="filter_selector" style="grid-area: 2 / 2;">
      <label><b>Attach To</b></label>

      <select id="presyn_neuron_btn"
          onmousedown="populate_neuron_menu(event, presyn_neuron_btn)"
          onchange="add_filter('Presynaptic', 'Neuron', presyn_neuron_btn)" >
        <option value="" selected>Presynaptic Neuron</option>
      </select>

      <select id="presyn_segment_btn"
          onmousedown="populate_segment_menu(event, presyn_segment_btn)"
          onchange="add_filter('Presynaptic', 'Segment', presyn_segment_btn)" >
        <option value="" selected>Presynaptic Segment</option>
      </select>

      <select id="postsyn_neuron_btn"
          onmousedown="populate_neuron_menu(event, postsyn_neuron_btn)"
          onchange="add_filter('Postsynaptic', 'Neuron', postsyn_neuron_btn)" >
        <option value="" selected>Postsynaptic Neuron</option>
      </select>

      <select id="postsyn_segment_btn"
          onmousedown="populate_segment_menu(event, postsyn_segment_btn)"
          onchange="add_filter('Postsynaptic', 'Segment', postsyn_segment_btn)" >
        <option value="" selected>Postsynaptic Segment</option>
      </select>

      <button onclick="filter_list.remove_item()" class="spancol">Remove</button>
    </div>

    <div id="insert_presyn_box" style="grid-area: 1 / 3;">
      <label><b>Presynaptic Mechanisms</b></label>
      <label for="insert_presyn_btn" style="display: none">Insert</label>
      <select id="insert_presyn_btn"
          onmousedown="presyn_mechanisms.populate_insert_menu(event)"
          onchange="presyn_mechanisms.insert_mechanism()" >
        <option value="" selected>Insert</option>
      </select>
      <button type="button" onclick="presyn_mechanisms.remove_item()">Remove</button>
      <form name="insert_presyn_settings" id="insert_presyn_settings" style="display: none"></form>
      <label for="insert_presyn_magnitude">Magnitude</label>
      <input id="insert_presyn_magnitude"
          type="number" required
          form="insert_presyn_settings"
          name="magnitude"
          min="0"
          step="0.01"
          value="1.0" />
    </div>

    <div id="insert_postsyn_box" style="grid-area: 2 / 3;">
      <label><b>Postsynaptic Mechanisms</b></label>
      <label for="insert_postsyn_btn" style="display: none">Insert</label>
      <select id="insert_postsyn_btn"
          onmousedown="postsyn_mechanisms.populate_insert_menu(event)"
          onchange="postsyn_mechanisms.insert_mechanism()" >
        <option value="" selected>Insert</option>
      </select>
      <button type="button" onclick="postsyn_mechanisms.remove_item()">Remove</button>
      <form name="insert_postsyn_settings" id="insert_postsyn_settings" style="display: none"></form>
      <label for="insert_postsyn_magnitude">Magnitude</label>
      <input id="insert_postsyn_magnitude"
          type="number" required
          form="insert_postsyn_settings"
          name="magnitude"
          min="0"
          step="0.01"
          value="1.0" />
    </div>
  </div>

  <script>
    class SynapseSelector extends Selector {
      select(obj) {
        set_form_values(synapse_settings, obj)
        filter_list.set_items(obj.filters)
        presyn_mechanisms.set_items(obj.presyn_mechanisms)
        postsyn_mechanisms.set_items(obj.postsyn_mechanisms)
        enable_synapse_settings()
      }
      deselect(obj) {
        get_form_values(synapse_settings, obj)
        obj.filters = filter_list.get_items()
        obj.presyn_mechanisms = presyn_mechanisms.get_items()
        obj.postsyn_mechanisms = postsyn_mechanisms.get_items()
        disable_synapse_settings()
      }
    }
    const synapse_list = new SynapseSelector(synapse_selector)

    function create_synapse() {
      synapse_list.add_item(new_synapse_name, {})
    }

    class SynapseFilters extends Selector {
      select(obj) {}
      deselect(obj) {}
    }
    function sort_filter(a, b) {
    }
    const filter_list = new SynapseFilters(filter_selector, keep_sorted=true)

    function populate_neuron_menu(event, menu) {
      if (event.buttons != 1) return
      while (menu.children.length > 1) {
        menu.removeChild(menu.lastChild)
      }
      for (const item of neuron_list.items) {
        menu.appendChild(new Option(item.name))
      }
    }

    function populate_segment_menu(event, menu) {
      if (event.buttons != 1) return
      while (menu.children.length > 1) {
        menu.removeChild(menu.lastChild)
      }
      let all_segments = new Set()
      for (const neuron of neuron_list.items) {
        for (const segment of neuron.program) {
          all_segments.add(segment.name)
        }
      }
      const sorted_segments = Array.from(all_segments)
      sorted_segments.sort()
      for (const name of sorted_segments) {
        menu.appendChild(new Option(name))
      }
    }

    function add_filter(location, type, menu) {
      if (menu.selectedIndex == 0) return
      const obj = {
        location: location,
        type: type,
      }
      const name = `${location} ${type} ${menu.value}`
      filter_list.add_item(name, obj)
      menu.selectedIndex = 0
    }

    const presyn_mechanisms = new InsertMechanisms(insert_presyn_box, insert_presyn_btn, insert_presyn_settings);
    const postsyn_mechanisms = new InsertMechanisms(insert_postsyn_box, insert_postsyn_btn, insert_postsyn_settings);

    function enable_synapse_settings() {
      enable_form(synapse_settings)
      filter_list.show()
      presyn_mechanisms.show()
      postsyn_mechanisms.show()
    }
    function disable_synapse_settings() {
      disable_form(synapse_settings)
      filter_list.hide()
      presyn_mechanisms.hide()
      postsyn_mechanisms.hide()
    }
    disable_synapse_settings()
  </script>
</section>

</body>
</html>
